<!DOCTYPE html>
<html>
<head>
    <title>JavaScript Injector</title>
</head>
<body>
    <div id="JavaScriptInjectorConfigPage" data-role="page" class="page type-interior pluginConfigurationPage">
        <div data-role="content">
            <div class="content-primary">
                <form id="JavaScriptInjectorConfigForm">
                    <div class="verticalSection verticalSection-extrabottompadding">
                        <div class="sectionTitleContainer flex align-items-center">
                            <h2 class="sectionTitle">JavaScript Injector</h2>
                            <a is="emby-linkbutton" class="raised raised-mini emby-button" style="margin-left: 2em;"
                                target="_blank" href="https://github.com/n00bcodr/Jellyfin-JavaScript-Injector">
                                <i class="md-icon button-icon button-icon-left secondaryText"></i>
                                <span>Help</span>
                            </a>
                        </div>
                        <hr><br>
                        <div id="scriptsContainer" class="verticalSection-extrabottompadding">
                            <!-- Script entries will be dynamically inserted here -->
                        </div>

                        <div class="verticalSection">
                            <button is="emby-button" type="button" id="addScriptBtn" class="raised button-submit block">
                                <span>Add Script</span>
                            </button>
                        </div>
                        <br/>
                        <div
                            style="background-color: rgba(255, 255, 255, 0.05); border-left: 4px solid #00a4dc; border-radius: 4px; padding: 1em 1.5em; margin: 1.5em 0; display: flex; align-items: center; gap: 1em;">
                            <i class="material-icons" style="color: #00a4dc; font-size: 24px;">info</i>
                            <div>
                                Changes require a browser refresh to take effect. <br/>
                                Scripts marked with 'Requires Authentication' will only be loaded for authenticated
                                users.
                            </div>
                        </div>
                        <br/>
                        <div>
                            <button is="emby-button" type="submit" class="raised button-submit block">
                                <span>Save</span>
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <template id="script-entry-template">
            <details class="verticalSection"
                style="background-color: rgba(255, 255, 255, 0.05); border-radius: 8px; margin-bottom: 1em; transition: box-shadow 0.3s ease;">
                <summary
                    style="cursor: pointer; list-style: none; display: flex; align-items: center; padding: 0.75em 1em;">
                    <i class="material-icons arrow-icon" style="transition: transform 0.2s ease-in-out;">arrow_right</i>
                    <h3 class="sectionTitle script-name-header" style="margin: 0 0 0 0.5em;"></h3>
                </summary>
                <div class="script-container" style="padding: 1.5em; border-top: 1px solid rgba(255, 255, 255, 0.1);">
                    <div class="inputContainer">
                        <input is="emby-input" type="text" class="script-name-input" label="Script Name:" />
                    </div>
                    <div class="inputContainer">
                        <textarea class="script-code-textarea emby-textarea emby-input"
                            style="height: 300px; width: 100%;"
                            placeholder="// Insert your custom JavaScript code here..."></textarea>
                    </div>
                    <div style="display: flex; align-items: center; gap: 2em; margin-top: 1em;">
                        <label class="emby-checkbox-label">
                            <input is="emby-checkbox" type="checkbox" class="script-enabled-checkbox" />
                            <span>Enabled</span>
                        </label>
                        <label class="emby-checkbox-label">
                            <input is="emby-checkbox" type="checkbox" class="script-auth-checkbox" />
                            <span>Requires Authentication</span>
                        </label>
                        <button is="emby-button" type="button" class="raised button-delete script-remove-btn">
                            <span>Remove</span>
                        </button>
                    </div>
                </div>
            </details>
        </template>

        <script type="text/javascript">
            var JavaScriptInjectorConfig = {
                pluginId: 'f5a34f7b-2e8a-4e6a-a722-3a216a81b374',

                loadConfiguration: function () {
                    Dashboard.showLoadingMsg();
                    ApiClient.getPluginConfiguration(JavaScriptInjectorConfig.pluginId).then(function (config) {
                        const scriptsContainer = document.querySelector('#scriptsContainer');
                        scriptsContainer.innerHTML = '';
                        if (config.CustomJavaScripts && config.CustomJavaScripts.length > 0) {
                            config.CustomJavaScripts.forEach((script) => {
                                scriptsContainer.appendChild(JavaScriptInjectorConfig.createScriptEntry(script));
                            });
                        }
                        Dashboard.hideLoadingMsg();
                    }).catch(function () {
                        Dashboard.hideLoadingMsg();
                    });
                },

                createScriptEntry: function (script) {
                    const template = document.querySelector('#script-entry-template');
                    const clone = template.content.cloneNode(true);

                    const detailsElement = clone.querySelector('details');
                    const nameHeader = clone.querySelector('.script-name-header');
                    const nameInput = clone.querySelector('.script-name-input');
                    const codeTextarea = clone.querySelector('.script-code-textarea');
                    const enabledCheckbox = clone.querySelector('.script-enabled-checkbox');
                    const authCheckbox = clone.querySelector('.script-auth-checkbox');
                    const removeBtn = clone.querySelector('.script-remove-btn');
                    const arrowIcon = clone.querySelector('.arrow-icon');

                    // Populate the cloned template with script data
                    nameHeader.textContent = script.Name;
                    nameInput.value = script.Name;
                    codeTextarea.value = script.Script;
                    enabledCheckbox.checked = script.Enabled;
                    authCheckbox.checked = script.RequiresAuthentication;

                    // Add event listeners
                    nameInput.addEventListener('input', (e) => {
                        nameHeader.textContent = e.target.value || 'New Script';
                    });

                    removeBtn.addEventListener('click', () => {
                        detailsElement.remove();
                    });

                    detailsElement.addEventListener('mouseover', () => {
                        detailsElement.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.4)';
                    });
                    detailsElement.addEventListener('mouseout', () => {
                        detailsElement.style.boxShadow = 'none';
                    });

                    // Handle arrow icon switching on toggle
                    detailsElement.addEventListener('toggle', () => {
                        arrowIcon.style.transform = detailsElement.open ? 'rotate(90deg)' : 'rotate(0deg)';
                    });

                    return clone;
                },

                saveConfiguration: function () {
                    Dashboard.showLoadingMsg();
                    const scripts = [];
                    document.querySelectorAll('#scriptsContainer .script-container').forEach(container => {
                        const name = container.querySelector('.script-name-input').value;
                        const script = container.querySelector('.script-code-textarea').value;
                        const enabled = container.querySelector('.script-enabled-checkbox').checked;
                        const requiresAuthentication = container.querySelector('.script-auth-checkbox').checked;
                        scripts.push({ Name: name, Script: script, Enabled: enabled, RequiresAuthentication: requiresAuthentication });
                    });

                    ApiClient.getPluginConfiguration(JavaScriptInjectorConfig.pluginId).then(function (config) {
                        config.CustomJavaScripts = scripts;
                        ApiClient.updatePluginConfiguration(JavaScriptInjectorConfig.pluginId, config).then(function (result) {
                            Dashboard.processPluginConfigurationUpdateResult(result);
                        });
                    });
                },

                registerEvents: function () {
                    document.querySelector('#JavaScriptInjectorConfigForm').addEventListener('submit', function (e) {
                        e.preventDefault();
                        JavaScriptInjectorConfig.saveConfiguration();
                        return false;
                    });

                    document.querySelector('#addScriptBtn').addEventListener('click', function () {
                        const scriptsContainer = document.querySelector('#scriptsContainer');
                        scriptsContainer.appendChild(JavaScriptInjectorConfig.createScriptEntry({ Name: 'New Script', Script: '', Enabled: true, RequiresAuthentication: false }));
                    });
                }
            };

            document.addEventListener('pageshow', function (e) {
                if (e.target.id === 'JavaScriptInjectorConfigPage') {
                    JavaScriptInjectorConfig.loadConfiguration();
                    JavaScriptInjectorConfig.registerEvents();
                }
            });
        </script>
    </div>
</body>

</html>