<!DOCTYPE html>
<html>
<head>
    <title>JavaScript Injector</title>
</head>
<body>
    <div id="JavaScriptInjectorConfigPage" data-role="page" class="page type-interior pluginConfigurationPage">
        <div data-role="content">
            <div class="content-primary">
                <form id="JavaScriptInjectorConfigForm">
                    <div class="verticalSection verticalSection-extrabottompadding">
                        <div class="sectionTitleContainer flex align-items-center">
                            <h2 class="sectionTitle">JavaScript Injector Settings</h2>
                        </div>

                        <div id="scriptsContainer" class="verticalSection-extrabottompadding">
                            </div>

                        <div class="verticalSection">
                            <button is="emby-button" type="button" id="addScriptBtn" class="raised button-submit block">
                                <span>Add Script</span>
                            </button>
                        </div>

                        <br/>
                        <div class="infoBox">
                             <p class="infoBoxText">
                                <strong>ℹ️</strong> Changes require a browser refresh to take effect. Scripts marked with 'Requires Authentication' will only be loaded for authenticated users.
                            </p>
                        </div>

                        <div>
                            <button is="emby-button" type="submit" class="raised button-submit block">
                                <span>Save</span>
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <template id="script-entry-template">
            <details class="verticalSection" style="border-radius: 8px; margin-bottom: 1em; box-shadow: inset 0 1px 1px rgba(255, 255, 255, 0.1), 0 2px 4px rgba(0, 0, 0, 0.5); transition: box-shadow 0.3s ease;">
                <summary style="cursor: pointer; list-style: none; display: flex; align-items: center; padding: 0.75em 1em;">
                    <i class="material-icons arrow-closed" style="display: inline-block;">arrow_right</i>
                    <i class="material-icons arrow-open" style="display: none;">arrow_drop_down</i>
                    <h3 class="sectionTitle script-name-header" style="margin: 0px 0px 0px 0.5em;"></h3>
                </summary>
                <div class="script-container" style="padding: 0 1.5em 1.5em 1.5em;">
                    <div class="inputContainer">
                        <input is="emby-input" type="text" class="script-name-input" label="Script Name:" />
                    </div>
                    <div class="inputContainer">
                        <textarea is="emby-textarea" class="script-code-textarea" label="JavaScript Code:" style="height: 300px; width: 100%;" placeholder="// Insert javascript code here"></textarea>
                    </div>
                    <div style="display: flex; align-items: center; gap: 2em; margin-top: 1em;">
                        <label class="emby-checkbox-label">
                            <input is="emby-checkbox" type="checkbox" class="script-enabled-checkbox" />
                            <span>Enabled</span>
                        </label>
                        <label class="emby-checkbox-label">
                            <input is="emby-checkbox" type="checkbox" class="script-auth-checkbox" />
                            <span>Requires Authentication</span>
                        </label>
                        <button is="emby-button" type="button" class="raised button-delete script-remove-btn">
                            <span>Remove</span>
                        </button>
                    </div>
                </div>
            </details>
        </template>

        <script type="text/javascript">
            var JavaScriptInjectorConfig = {
                pluginId: 'f5a34f7b-2e8a-4e6a-a722-3a216a81b374',

                loadConfiguration: function() {
                    Dashboard.showLoadingMsg();
                    ApiClient.getPluginConfiguration(JavaScriptInjectorConfig.pluginId).then(function (config) {
                        const scriptsContainer = document.querySelector('#scriptsContainer');
                        scriptsContainer.innerHTML = '';
                        if (config.CustomJavaScripts && config.CustomJavaScripts.length > 0) {
                            config.CustomJavaScripts.forEach((script) => {
                                scriptsContainer.appendChild(JavaScriptInjectorConfig.createScriptEntry(script));
                            });
                        }
                        Dashboard.hideLoadingMsg();
                    }).catch(function() {
                        Dashboard.hideLoadingMsg();
                    });
                },

                createScriptEntry: function(script) {
                    const template = document.querySelector('#script-entry-template');
                    const clone = template.content.cloneNode(true);

                    const detailsElement = clone.querySelector('details');
                    const nameHeader = clone.querySelector('.script-name-header');
                    const nameInput = clone.querySelector('.script-name-input');
                    const codeTextarea = clone.querySelector('.script-code-textarea');
                    const enabledCheckbox = clone.querySelector('.script-enabled-checkbox');
                    const authCheckbox = clone.querySelector('.script-auth-checkbox');
                    const removeBtn = clone.querySelector('.script-remove-btn');
                    const arrowOpen = clone.querySelector('.arrow-open');
                    const arrowClosed = clone.querySelector('.arrow-closed');

                    // Populate the cloned template with script data
                    nameHeader.textContent = script.Name;
                    nameInput.value = script.Name;
                    codeTextarea.value = script.Script;
                    enabledCheckbox.checked = script.Enabled;
                    authCheckbox.checked = script.RequiresAuthentication;

                    // Add event listeners
                    nameInput.addEventListener('input', (e) => {
                        nameHeader.textContent = e.target.value || 'New Script';
                    });

                    removeBtn.addEventListener('click', () => {
                        detailsElement.remove();
                    });

                    // Handle hover effect for box-shadow
                    const defaultShadow = 'inset 0 1px 1px rgba(255, 255, 255, 0.1), 0 2px 4px rgba(0, 0, 0, 0.5)';
                    const hoverShadow = 'inset 0 1px 1px rgba(255, 255, 255, 0.1), 0 4px 8px rgba(0, 0, 0, 0.6)';
                    detailsElement.addEventListener('mouseover', () => {
                        detailsElement.style.boxShadow = hoverShadow;
                    });
                    detailsElement.addEventListener('mouseout', () => {
                        detailsElement.style.boxShadow = defaultShadow;
                    });

                    // Handle arrow icon switching on toggle
                    detailsElement.addEventListener('toggle', () => {
                        if (detailsElement.open) {
                            arrowOpen.style.display = 'inline-block';
                            arrowClosed.style.display = 'none';
                        } else {
                            arrowOpen.style.display = 'none';
                            arrowClosed.style.display = 'inline-block';
                        }
                    });


                    return clone;
                },

                saveConfiguration: function() {
                    Dashboard.showLoadingMsg();
                    const scripts = [];
                    document.querySelectorAll('#scriptsContainer .script-container').forEach(container => {
                        const name = container.querySelector('.script-name-input').value;
                        const script = container.querySelector('.script-code-textarea').value;
                        const enabled = container.querySelector('.script-enabled-checkbox').checked;
                        const requiresAuthentication = container.querySelector('.script-auth-checkbox').checked;
                        scripts.push({ Name: name, Script: script, Enabled: enabled, RequiresAuthentication: requiresAuthentication });
                    });

                    ApiClient.getPluginConfiguration(JavaScriptInjectorConfig.pluginId).then(function (config) {
                        config.CustomJavaScripts = scripts;
                        ApiClient.updatePluginConfiguration(JavaScriptInjectorConfig.pluginId, config).then(function (result) {
                            Dashboard.processPluginConfigurationUpdateResult(result);
                        });
                    });
                },

                registerEvents: function() {
                    document.querySelector('#JavaScriptInjectorConfigForm').addEventListener('submit', function(e) {
                        e.preventDefault();
                        JavaScriptInjectorConfig.saveConfiguration();
                        return false;
                    });

                    document.querySelector('#addScriptBtn').addEventListener('click', function() {
                        const scriptsContainer = document.querySelector('#scriptsContainer');
                        scriptsContainer.appendChild(JavaScriptInjectorConfig.createScriptEntry({ Name: 'New Script', Script: '', Enabled: true, RequiresAuthentication: false }));
                    });
                }
            };

            document.addEventListener('pageshow', function(e) {
                if (e.target.id === 'JavaScriptInjectorConfigPage') {
                   JavaScriptInjectorConfig.loadConfiguration();
                   JavaScriptInjectorConfig.registerEvents();
                }
            });
        </script>
    </div>
</body>
</html>