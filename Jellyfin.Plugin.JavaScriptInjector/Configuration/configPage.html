<!DOCTYPE html>
<html>
  <head>
    <title>JavaScript Injector</title>
  </head>
  <body>
    <div
      id="JavaScriptInjectorConfigPage"
      data-role="page"
      class="page type-interior pluginConfigurationPage"
    >
      <div data-role="content">
        <div class="content-primary">
          <form id="JavaScriptInjectorConfigForm">
            <div class="verticalSection verticalSection-extrabottompadding">
              <div class="sectionTitleContainer flex align-items-center">
                <h2 class="sectionTitle">JavaScript Injector</h2>
                <a
                  is="emby-linkbutton"
                  class="raised raised-mini emby-button"
                  style="margin-left: 2em"
                  target="_blank"
                  href="https://github.com/n00bcodr/Jellyfin-JavaScript-Injector"
                >
                  <i class="md-icon button-icon button-icon-left secondaryText"></i>
                  <span>Help</span>
                </a>
              </div>
              <hr />
              <br />
              <div id="scriptsContainer" class="verticalSection-extrabottompadding">
                <!-- User script entries will be dynamically inserted here -->
              </div>

              <div class="verticalSection">
                <button
                  is="emby-button"
                  type="button"
                  id="addScriptBtn"
                  class="raised button-submit block"
                >
                  <span>Add Script</span>
                </button>
              </div>

              <!-- Plugin Scripts Section -->
              <div id="pluginScriptsSection" class="verticalSection" style="display: none">
                <h3 class="sectionTitle">Plugin Scripts</h3>
                <p style="color: #888; margin-bottom: 1em">
                  These scripts were added by other plugins and cannot be edited here. You can only
                  view or delete them.
                </p>
                <div id="pluginScriptsContainer" class="verticalSection-extrabottompadding">
                  <!-- Plugin script entries will be dynamically inserted here -->
                </div>
              </div>
              <br />
              <div
                style="
                  background-color: rgba(255, 255, 255, 0.05);
                  border-left: 4px solid #00a4dc;
                  border-radius: 4px;
                  padding: 1em 1.5em;
                  margin: 1.5em 0;
                  display: flex;
                  align-items: center;
                  gap: 1em;
                "
              >
                <i class="material-icons" style="color: #00a4dc; font-size: 24px">info</i>
                <div>
                  Changes require a browser refresh to take effect. <br />
                  Scripts marked with 'Requires Authentication' will only be loaded for
                  authenticated users.
                </div>
              </div>
              <br />
              <div>
                <button is="emby-button" type="submit" class="raised button-submit block">
                  <span>Save</span>
                </button>
              </div>
            </div>
          </form>
        </div>
      </div>

      <template id="script-entry-template">
        <details
          class="verticalSection"
          style="
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            margin-bottom: 1em;
          "
        >
          <summary
            style="
              cursor: pointer;
              list-style: none;
              display: flex;
              align-items: center;
              padding: 0.75em 1em;
            "
          >
            <i class="material-icons arrow-icon" style="transition: transform 0.2s ease-in-out"
              >arrow_right</i
            >
            <h3 class="sectionTitle script-name-header" style="margin: 0 0 0 0.5em"></h3>
          </summary>
          <div
            class="script-container"
            style="padding: 1.5em; border-top: 1px solid rgba(255, 255, 255, 0.1)"
          >
            <div class="inputContainer">
              <input is="emby-input" type="text" class="script-name-input" label="Script Name:" />
            </div>
            <div class="inputContainer">
              <textarea
                class="script-code-textarea emby-textarea emby-input"
                style="height: 300px; width: 100%"
                placeholder="// Insert your custom JavaScript code here..."
              ></textarea>
            </div>
            <div style="display: flex; align-items: center; gap: 2em; margin-top: 1em">
              <label class="emby-checkbox-label">
                <input is="emby-checkbox" type="checkbox" class="script-enabled-checkbox" />
                <span>Enabled</span>
              </label>
              <label class="emby-checkbox-label">
                <input is="emby-checkbox" type="checkbox" class="script-auth-checkbox" />
                <span>Requires Authentication</span>
              </label>
              <button is="emby-button" type="button" class="raised button-delete script-remove-btn">
                <span>Remove</span>
              </button>
            </div>
          </div>
        </details>
      </template>

      <template id="plugin-script-entry-template">
        <details
          class="verticalSection"
          style="
            background-color: rgba(255, 193, 7, 0.1);
            border-left: 4px solid #ffc107;
            border-radius: 8px;
            margin-bottom: 1em;
          "
        >
          <summary
            style="
              cursor: pointer;
              list-style: none;
              display: flex;
              align-items: center;
              padding: 0.75em 1em;
            "
          >
            <i class="material-icons arrow-icon" style="transition: transform 0.2s ease-in-out"
              >arrow_right</i
            >
            <h3 class="sectionTitle plugin-script-name-header" style="margin: 0 0 0 0.5em"></h3>
          </summary>
          <div
            class="plugin-script-container"
            style="padding: 1.5em; border-top: 1px solid rgba(255, 193, 7, 0.3)"
          >
            <div
              class="plugin-info"
              style="
                background-color: rgba(255, 193, 7, 0.05);
                border-radius: 4px;
                padding: 1em;
                margin-bottom: 1em;
              "
            >
              <h4 style="margin: 0 0 0.5em 0; color: #ffc107">Plugin Information</h4>
              <p style="margin: 0.25em 0">
                <strong>Plugin Name:</strong> <span class="plugin-name"></span>
              </p>
              <p style="margin: 0.25em 0">
                <strong>Plugin Version:</strong>
                <span class="plugin-version"></span>
              </p>
              <p style="margin: 0.25em 0">
                <strong>Script ID:</strong>
                <span class="plugin-script-id"></span>
              </p>
            </div>
            <div class="inputContainer">
              <textarea
                class="plugin-script-code-textarea emby-textarea emby-input"
                style="height: 300px; width: 100%"
                readonly
                placeholder="Script content will be displayed here..."
              ></textarea>
            </div>
            <div style="display: flex; align-items: center; gap: 2em; margin-top: 1em">
              <label class="emby-checkbox-label">
                <input is="emby-checkbox" type="checkbox" class="plugin-script-enabled-checkbox" />
                <span>Enabled</span>
              </label>
              <label class="emby-checkbox-label">
                <input
                  is="emby-checkbox"
                  type="checkbox"
                  class="plugin-script-auth-checkbox"
                  disabled
                />
                <span>Requires Authentication</span>
              </label>
              <button
                is="emby-button"
                type="button"
                class="raised button-delete plugin-script-remove-btn"
              >
                <span>Delete</span>
              </button>
            </div>
          </div>
        </details>
      </template>

      <script type="text/javascript">
        var JavaScriptInjectorConfig = {
          pluginId: "f5a34f7b-2e8a-4e6a-a722-3a216a81b374",

          loadConfiguration: function () {
            Dashboard.showLoadingMsg();
            ApiClient.getPluginConfiguration(JavaScriptInjectorConfig.pluginId)
              .then(function (config) {
                const scriptsContainer = document.querySelector("#scriptsContainer");
                const pluginScriptsContainer = document.querySelector("#pluginScriptsContainer");
                const pluginScriptsSection = document.querySelector("#pluginScriptsSection");

                scriptsContainer.innerHTML = "";
                pluginScriptsContainer.innerHTML = "";

                // Load user scripts
                if (config.CustomJavaScripts && config.CustomJavaScripts.length > 0) {
                  config.CustomJavaScripts.forEach((script) => {
                    scriptsContainer.appendChild(
                      JavaScriptInjectorConfig.createScriptEntry(script)
                    );
                  });
                }

                // Load plugin scripts
                if (config.PluginJavaScripts && config.PluginJavaScripts.length > 0) {
                  config.PluginJavaScripts.forEach((script) => {
                    pluginScriptsContainer.appendChild(
                      JavaScriptInjectorConfig.createPluginScriptEntry(script)
                    );
                  });
                  pluginScriptsSection.style.display = "block";
                } else {
                  pluginScriptsSection.style.display = "none";
                }

                Dashboard.hideLoadingMsg();
              })
              .catch(function () {
                Dashboard.hideLoadingMsg();
              });
          },

          createScriptEntry: function (script) {
            const template = document.querySelector("#script-entry-template");
            const clone = template.content.cloneNode(true);

            const detailsElement = clone.querySelector("details");
            const nameHeader = clone.querySelector(".script-name-header");
            const nameInput = clone.querySelector(".script-name-input");
            const codeTextarea = clone.querySelector(".script-code-textarea");
            const enabledCheckbox = clone.querySelector(".script-enabled-checkbox");
            const authCheckbox = clone.querySelector(".script-auth-checkbox");
            const removeBtn = clone.querySelector(".script-remove-btn");
            const arrowIcon = clone.querySelector(".arrow-icon");

            // Populate the cloned template with script data
            nameHeader.textContent = script.Name;
            nameInput.value = script.Name;
            codeTextarea.value = script.Script;
            enabledCheckbox.checked = script.Enabled;
            authCheckbox.checked = script.RequiresAuthentication;

            // Add event listeners
            nameInput.addEventListener("input", (e) => {
              nameHeader.textContent = e.target.value || "New Script";
            });

            removeBtn.addEventListener("click", () => {
              detailsElement.remove();
            });

            // Handle arrow icon switching on toggle
            detailsElement.addEventListener("toggle", () => {
              arrowIcon.style.transform = detailsElement.open ? "rotate(90deg)" : "rotate(0deg)";
            });

            return clone;
          },

          createPluginScriptEntry: function (script) {
            const template = document.querySelector("#plugin-script-entry-template");
            const clone = template.content.cloneNode(true);

            const detailsElement = clone.querySelector("details");
            const nameHeader = clone.querySelector(".plugin-script-name-header");
            const codeTextarea = clone.querySelector(".plugin-script-code-textarea");
            const enabledCheckbox = clone.querySelector(".plugin-script-enabled-checkbox");
            const authCheckbox = clone.querySelector(".plugin-script-auth-checkbox");
            const removeBtn = clone.querySelector(".plugin-script-remove-btn");
            const arrowIcon = clone.querySelector(".arrow-icon");
            const pluginName = clone.querySelector(".plugin-name");
            const pluginVersion = clone.querySelector(".plugin-version");
            const pluginScriptId = clone.querySelector(".plugin-script-id");

            // Populate the cloned template with script data
            nameHeader.textContent = script.Name;
            codeTextarea.value = script.Script;
            enabledCheckbox.checked = script.Enabled;
            authCheckbox.checked = script.RequiresAuthentication;
            pluginName.textContent = script.PluginName || "Unknown Plugin";
            pluginVersion.textContent = script.PluginVersion || "Unknown Version";
            pluginScriptId.textContent = script.Id || "Unknown ID";

            // Store the script ID for deletion
            detailsElement.setAttribute("data-script-id", script.Id);

            // Add event listeners
            enabledCheckbox.addEventListener("change", () => {
              // Update the enabled state in the configuration immediately
              JavaScriptInjectorConfig.updatePluginScriptEnabled(
                script.Id,
                enabledCheckbox.checked
              );
            });

            removeBtn.addEventListener("click", () => {
              if (
                confirm(
                  `Are you sure you want to delete the plugin script "${script.Name}" from "${script.PluginName}"?`
                )
              ) {
                JavaScriptInjectorConfig.deletePluginScript(script.Id, detailsElement);
              }
            });

            // Handle arrow icon switching on toggle
            detailsElement.addEventListener("toggle", () => {
              arrowIcon.style.transform = detailsElement.open ? "rotate(90deg)" : "rotate(0deg)";
            });

            return clone;
          },

          saveConfiguration: function () {
            Dashboard.showLoadingMsg();
            const scripts = [];
            // Only save user scripts, not plugin scripts
            document
              .querySelectorAll("#scriptsContainer .script-container")
              .forEach((container) => {
                const name = container.querySelector(".script-name-input").value;
                const script = container.querySelector(".script-code-textarea").value;
                const enabled = container.querySelector(".script-enabled-checkbox").checked;
                const requiresAuthentication =
                  container.querySelector(".script-auth-checkbox").checked;
                scripts.push({
                  Name: name,
                  Script: script,
                  Enabled: enabled,
                  RequiresAuthentication: requiresAuthentication,
                });
              });

            ApiClient.getPluginConfiguration(JavaScriptInjectorConfig.pluginId).then(function (
              config
            ) {
              config.CustomJavaScripts = scripts;
              // Don't modify PluginJavaScripts array here
              ApiClient.updatePluginConfiguration(JavaScriptInjectorConfig.pluginId, config).then(
                function (result) {
                  Dashboard.processPluginConfigurationUpdateResult(result);
                }
              );
            });
          },

          updatePluginScriptEnabled: function (scriptId, enabled) {
            ApiClient.getPluginConfiguration(JavaScriptInjectorConfig.pluginId).then(function (
              config
            ) {
              const script = config.PluginJavaScripts.find((s) => s.Id === scriptId);
              if (script) {
                script.Enabled = enabled;
                ApiClient.updatePluginConfiguration(JavaScriptInjectorConfig.pluginId, config).then(
                  function () {
                    // Silently update without showing success message
                  }
                );
              }
            });
          },

          deletePluginScript: function (scriptId, detailsElement) {
            ApiClient.getPluginConfiguration(JavaScriptInjectorConfig.pluginId).then(function (
              config
            ) {
              const scriptIndex = config.PluginJavaScripts.findIndex((s) => s.Id === scriptId);
              if (scriptIndex !== -1) {
                config.PluginJavaScripts.splice(scriptIndex, 1);
                ApiClient.updatePluginConfiguration(JavaScriptInjectorConfig.pluginId, config).then(
                  function () {
                    detailsElement.remove();
                    // Hide plugin section if no more plugin scripts
                    if (config.PluginJavaScripts.length === 0) {
                      document.querySelector("#pluginScriptsSection").style.display = "none";
                    }
                  }
                );
              }
            });
          },

          registerEvents: function () {
            document
              .querySelector("#JavaScriptInjectorConfigForm")
              .addEventListener("submit", function (e) {
                e.preventDefault();
                JavaScriptInjectorConfig.saveConfiguration();
                return false;
              });

            document.querySelector("#addScriptBtn").addEventListener("click", function () {
              const scriptsContainer = document.querySelector("#scriptsContainer");
              scriptsContainer.appendChild(
                JavaScriptInjectorConfig.createScriptEntry({
                  Name: "New Script",
                  Script: "",
                  Enabled: true,
                  RequiresAuthentication: false,
                })
              );
            });
          },
        };

        document.addEventListener("pageshow", function (e) {
          if (e.target.id === "JavaScriptInjectorConfigPage") {
            JavaScriptInjectorConfig.loadConfiguration();
            JavaScriptInjectorConfig.registerEvents();
          }
        });
      </script>
    </div>
  </body>
</html>
